<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Opiniones de Asignaturas ‚Äì Artes UNAL</title>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">

</head>

<body>

<div class="contenedor">
    <div class="header-decor"></div>

    <!-- PASO EMAIL -->
    <div id="pasoEmail">
        <div class="paso-email">
            <div class="logo">
                <h1><span class="logo-icon">üé®</span> Opiniones Artes UNAL</h1>
            </div>
            
            <div class="info-box">
                <p><strong>¬°Bienvenido estudiante UNAL!</strong></p>
                <p>Tu opini√≥n es valiosa para mejorar la experiencia acad√©mica de toda la comunidad.</p>
            </div>

            <h2>Verificaci√≥n de correo institucional</h2>
            <p>Por favor ingresa tu correo institucional para continuar:</p>
            
            <div class="card">
                <div class="input-group email-validation">
                    <label for="correoInstitucional">
                        <span class="icon">üìß</span> Correo institucional UNAL
                        <span class="required">*</span>
                    </label>
                    <input type="email" id="correoInstitucional" 
                           placeholder="pepitoperez@unal.edu.co"
                           oninput="validarCorreo(this.value)">
                    <span class="validation-icon valid">‚úì</span>
                    <span class="validation-icon invalid">‚úó</span>
                    <div class="error-message" id="errorCorreo">El correo debe terminar en @unal.edu.co</div>
                </div>
                
                <p class="email-instructions">
                    Solo se permiten correos institucionales de la Universidad Nacional de Colombia.
                    Ejemplo: nombre.apellido@unal.edu.co
                </p>
                
                <button class="boton" onclick="verificarCorreo()" id="btnContinuarCorreo" disabled>
                    <span>üëâ</span> Continuar a selecci√≥n de asignaturas
                </button>
            </div>
        </div>
    </div>

    <!-- PANTALLA FINAL -->
    <div id="pantallaFinal" class="oculto">
        <div class="completion-message">
            <div class="completion-icon">üé®</div>
            <h1>¬°Gracias por tu participaci√≥n! ü§ç</h1>
            <p>
                Tu opini√≥n es invaluable para la comunidad estudiantil. 
                Estos datos ayudar√°n a futuros estudiantes a tomar decisiones m√°s informadas 
                sobre su trayectoria acad√©mica.
            </p>
            
            <div class="representantes-info">
                <h4>¬øM√°s informaci√≥n o sugerencias?</h4>
                <p>Puedes contactar a tus representantes estudiantiles:</p>
                <p><strong>Santiago Andr√©s Tuberquia</strong> y <strong>Santiago Mej√≠a Corredor</strong></p>
                <p style="margin-top: 10px; font-size: 14px; color: var(--gray-medium);">
                    Est√°n disponibles para escuchar tus inquietudes y mejorar esta iniciativa.
                </p>
            </div>

            <div class="info-box">
                <p><strong>¬°Comparte esta herramienta con tus compa√±eros!</strong></p>
                <p>Cuantas m√°s opiniones tengamos, m√°s √∫til ser√° para todos.</p>
            </div>
            
            <div class="data-summary">
                <h3>Resumen de tus respuestas</h3>
                <div id="resumenRespuestas"></div>
            </div>
            
            <button class="boton" onclick="reiniciar()">
                <span>üìù</span> Llenar otro formulario
            </button>
        </div>
    </div>

    <!-- PASO 1: SELECCI√ìN -->
    <div id="pasoSeleccion" class="oculto">
        <div class="logo">
            <h1><span class="logo-icon">üé®</span> Opiniones Artes UNAL</h1>
            <p>Estudiante: <strong id="correoMostrado"></strong></p>
        </div>
        
        <div class="info-box">
            <p><strong>¬øC√≥mo funciona?</strong></p>
            <p>1. Selecciona hasta 5 asignaturas que hayas cursado</p>
            <p>2. Da tu opini√≥n sobre cada una</p>
            <p>3. ¬°Comparte y ayuda a la comunidad!</p>
        </div>

        <h2>Selecciona hasta 5 asignaturas</h2>
        <p>Elige las materias sobre las que quieres dar tu opini√≥n:</p>

        <div class="card">
            <!-- BUSCADOR DE ASIGNATURAS -->
            <div class="input-group" style="margin-bottom: 15px;">
                <label for="buscarAsignatura"><strong>Buscar asignatura:</strong></label>
                <input type="text" id="buscarAsignatura" 
                       placeholder="Escribe para filtrar asignaturas..."
                       oninput="filtrarAsignaturas()">
            </div>
            
            <label for="selectAsignaturas"><strong>Lista de asignaturas:</strong></label>
            <select id="selectAsignaturas" onchange="agregarAsignatura()">
                <option value="">‚Äî Selecciona una asignatura ‚Äî</option>

                <!-- LISTA COMPLETA -->
                <option>Aproximaci√≥n a los procesos cer√°micos (3010611)</option>
                <option>Arte y archivo (3009874)</option>
                <option>Arte y ciudad:(3010614)</option>
                <option>Arte y documento (3009875)</option>
                <option>B√°sico espacio I (3009837)</option>
                <option>B√°sico espacio II (3009838)</option>
                <option>B√°sico imagen I (3010734)</option>
                <option>B√°sico imagen II (3010735)</option>
                <option>Herramientas digitales I (3009879)</option>
                <option>Herramientas digitales II (3009880)</option>
                <option>Historia del arte I (3006669)</option>
                <option>Historia del arte II (3010698)</option>
                <option>Historia del arte III (3006671)</option>
                <option>Historia del performance I (3010609)</option>
                <option>Historia del performance II (3010608)</option>
                <option>Instalaciones e intervenciones (3010629)</option>
                <option>Laboratorio de dibujo I (3009841)</option>
                <option>Laboratorio de dibujo II (3009842)</option>
                <option>Laboratorio de escultura I (3009843)</option>
                <option>Laboratorio de escultura II (3009844)</option>
                <option>Laboratorio de fotograf√≠a I (3010736)</option>
                <option>Laboratorio de fotograf√≠a II (3010737)</option>
                <option>Laboratorio de gr√°fica I (3006683)</option>
                <option>Laboratorio de gr√°fica II (3009882)</option>
                <option>Laboratorio de medios no tradicionales (3009885)</option>
                <option>Laboratorio de pintura I (3009848)</option>
                <option>Laboratorio de pintura II (3009849)</option>
                <option>Laboratorio de t√©cnicas gr√°ficas (3009887)</option>
                <option>Laboratorio de t√©cnicas pict√≥ricas (3009888)</option>
                <option>Laboratorio de video I (3009850)</option>
                <option>Laboratorio de video II (3009851)</option>
                <option>Pr√°cticas art√≠sticas contempor√°neas en Colombia (3010636)</option>
                <option>Pr√°cticas art√≠sticas I (3009852)</option>
                <option>Pr√°cticas art√≠sticas II (3009853)</option>
                <option>Realizaci√≥n documental (3009892)</option>
                <option>Seminario I (3009854)</option>
                <option>Seminario II (3006700)</option>
                <option>Seminario III (3006701)</option>
                <option>Seminario de investigaci√≥n I (3009855)</option>
                <option>Seminario de investigaci√≥n II (3009856)</option>
                <option>Taller II (3009858)</option>
                <option>Taller III (3009859)</option>
                <option>Taller IV (3009860)</option>
                <option>Taller V (3009861)</option>
                <option>Taller VI (3009862)</option>
                <option>Taller VII (3009863)</option>
            </select>

            <div id="listaAsignaturas" style="margin-top: 25px;"></div>
            <div class="contador" id="contador">0 / 5 seleccionadas</div>
        </div>

        <button class="boton" onclick="iniciar()" id="btnContinuarAsignaturas" disabled>
            <span>üëâ</span> Continuar a opiniones
        </button>
    </div>

    <!-- PASO 2: FORMULARIO -->
    <div id="pasoFormulario" class="oculto">
        <div class="progreso" id="progreso"></div>
        
        <div class="highlight-card">
            <h2>üí¨ Opinando sobre:</h2>
            <div class="materia-nombre" id="tituloAsignatura"></div>
            <p style="margin-top: 15px; color: var(--gray-medium); font-size: 14px;">
                Todos los campos son obligatorios excepto los comentarios escritos
            </p>
        </div>

        <form id="formularioAsignatura">
            <!-- BLOQUE GENERAL (NO TALLER) -->
            <div id="bloqueGeneral">
                <div class="card">
                    <h3>Enfoque de la asignatura <span class="required">*</span></h3>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="enfoque" value="Te√≥rica" onchange="mostrarDescripcion('teorica')">
                            <span>Te√≥rica</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="enfoque" value="Investigaci√≥n" onchange="mostrarDescripcion('investigacion')">
                            <span>Investigaci√≥n</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="enfoque" value="T√©cnica" onchange="mostrarDescripcion('tecnica')">
                            <span>T√©cnica</span>
                        </label>
                    </div>
                    <div id="descripcionEnfoque" class="descripcion-opcion oculto"></div>
                    <div class="error-message" id="errorEnfoque">Debes seleccionar al menos un enfoque</div>

                    <h3>Modo de calificaci√≥n <span class="required">*</span></h3>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="calificacion" value="Pr√°cticas y entregas f√≠sicas" onchange="mostrarDescripcion('practicas')">
                            <span>Pr√°cticas y entregas f√≠sicas</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="calificacion" value="Entregas de proyectos" onchange="mostrarDescripcion('proyectos')">
                            <span>Entregas de proyectos</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="calificacion" value="Lecturas o exposiciones" onchange="mostrarDescripcion('lecturas')">
                            <span>Lecturas o exposiciones</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="calificacion" value="Reflexi√≥n y participaci√≥n en clase" onchange="mostrarDescripcion('participacion')">
                            <span>Reflexi√≥n y participaci√≥n en clase</span>
                        </label>
                    </div>
                    <div id="descripcionCalificacion" class="descripcion-opcion oculto"></div>
                    <div class="error-message" id="errorCalificacion">Debes seleccionar al menos un modo de calificaci√≥n</div>
                </div>

                <div class="card">
                    <h3>Nivel de carga acad√©mica <span class="required">*</span></h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="carga" value="Baja">
                            <span>Baja</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="carga" value="Media">
                            <span>Media</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="carga" value="Alta">
                            <span>Alta</span>
                        </label>
                    </div>
                    <div class="error-message" id="errorCarga">Debes seleccionar el nivel de carga</div>

                    <h3>Gasto econ√≥mico <span class="required">*</span></h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="gasto" value="Casi ninguno">
                            <span>Casi ninguno</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="gasto" value="Bajo">
                            <span>Bajo</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="gasto" value="Medio">
                            <span>Medio</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="gasto" value="Alto">
                            <span>Alto</span>
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="gasto" value="Muy alto">
                            <span>Muy alto</span>
                        </label>
                    </div>
                    <div class="error-message" id="errorGasto">Debes seleccionar el nivel de gasto</div>
                </div>

                <div class="card">
                    <h3>Valoraci√≥n de la asignatura <span class="required">*</span></h3>
                    <p class="rating-label">Califica del 1 al 5 estrellas</p>
                    <div class="estrellas" id="estrellasAsignatura">
                        <label><input type="radio" name="ratingAsignatura" value="1" style="display: none;"><span onclick="calificar(1, 'asignatura')">‚òÖ</span></label>
                        <label><input type="radio" name="ratingAsignatura" value="2" style="display: none;"><span onclick="calificar(2, 'asignatura')">‚òÖ</span></label>
                        <label><input type="radio" name="ratingAsignatura" value="3" style="display: none;"><span onclick="calificar(3, 'asignatura')">‚òÖ</span></label>
                        <label><input type="radio" name="ratingAsignatura" value="4" style="display: none;"><span onclick="calificar(4, 'asignatura')">‚òÖ</span></label>
                        <label><input type="radio" name="ratingAsignatura" value="5" style="display: none;"><span onclick="calificar(5, 'asignatura')">‚òÖ</span></label>
                    </div>
                    <div class="error-message" id="errorRatingAsignatura">Debes calificar la asignatura</div>

                    <h3>Opini√≥n sobre la asignatura (opcional)</h3>
                    <textarea id="opinionAsignatura" placeholder="Escribe aqu√≠ tu experiencia personal, qu√© aprendiste, qu√© te gust√≥ o qu√© mejorar√≠as..."></textarea>
                </div>
            </div>

            <!-- BLOQUE DOCENTE -->
            <div id="bloqueDocente" class="card">
                <h3>Docente <span class="required">*</span></h3>
                <select id="docente" onchange="manejarCambioDocente()">
                    <option value="">‚Äî Selecciona el docente ‚Äî</option>
                    <option>Camilo Rodr√≠guez Castro</option>
                    <option>Carolina V√©lez Luj√°n</option>
                    <option>Catalina del Roc√≠o Rojas Casallas</option>
                    <option>Daniela Serna Gallego</option>
                    <option>Edna Yulieth Sierra Duque</option>
                    <option>Fernando Celimo Escobar Neira</option>
                    <option>Sandra Carolina Chac√≥n Bernal</option>
                    <option>Hebert Rodr√≠guez Garc√≠a</option>
                    <option>Jairo Augusto Sol√≥rzano Ariza</option>
                    <option>Jorge Alberto Rodr√≠guez Salazarriaga</option>
                    <option>Jorge Andr√©s Mar√≠n V√°squez</option>
                    <option>Juan Guillermo Caicedo</option>
                    <option>Luis Eduardo Serna</option>
                    <option>Mar√≠a Ang√©lica Teuta Echeverri</option>
                    <option>Mar√≠a Isabel Naranjo Cano</option>
                    <option>Miguel √Ångel Flores Santander</option>
                    <option>Nadia Ximena Lorena Moreno</option>
                    <option>Natalia Echeverri Arango</option>
                    <option>Natalia Isabel P√©rez Villegas</option>
                    <option>Natalia Restrepo Restrepo</option>
                    <option>√ìscar Mauricio Ardila Luna</option>
                    <option>Paula Marcela Restrepo Cardona</option>
                    <option>Paulina Escobar Aguirre</option>
                    <option>Pedro Antonio Agudelo Rend√≥n</option>
                    <option>Sebasti√°n Alexi Wiedemann</option>
                    <option>V√©ronique Marie Christine Mondejar</option>
                    <option value="otro">Otro (especificar)</option>
                </select>
                
                <div id="inputOtroDocente" class="input-otro-docente oculto">
                    <label for="nombreOtroDocente">Nombre del docente:</label>
                    <input type="text" id="nombreOtroDocente" placeholder="Escribe el nombre completo del docente">
                    <div class="error-message" id="errorOtroDocente">Debes escribir el nombre del docente</div>
                </div>

                <div class="error-message" id="errorDocente">Debes seleccionar un docente</div>

                <h3 style="margin-top: 20px;">Valoraci√≥n del docente <span class="required">*</span></h3>
                <p class="rating-label">Califica del 1 al 5 estrellas</p>
                <div class="estrellas" id="estrellasDocente">
                    <label><input type="radio" name="ratingDocente" value="1" style="display: none;"><span onclick="calificar(1, 'docente')">‚òÖ</span></label>
                    <label><input type="radio" name="ratingDocente" value="2" style="display: none;"><span onclick="calificar(2, 'docente')">‚òÖ</span></label>
                    <label><input type="radio" name="ratingDocente" value="3" style="display: none;"><span onclick="calificar(3, 'docente')">‚òÖ</span></label>
                    <label><input type="radio" name="ratingDocente" value="4" style="display: none;"><span onclick="calificar(4, 'docente')">‚òÖ</span></label>
                    <label><input type="radio" name="ratingDocente" value="5" style="display: none;"><span onclick="calificar(5, 'docente')">‚òÖ</span></label>
                </div>
                <div class="error-message" id="errorRatingDocente">Debes calificar al docente</div>

                <h3>Opini√≥n sobre el docente (opcional)</h3>
                    <textarea id="opinionDocente" placeholder="Comentarios sobre la metodolog√≠a, trato con estudiantes, claridad, etc..."></textarea>
            </div>
        </form>

        <div class="botones-container">
            <button class="boton boton-sec" onclick="anterior()" id="btnAnterior">
                <span>‚¨ÖÔ∏è</span> Asignatura anterior
            </button>
            <button class="boton" onclick="siguiente()" id="btnSiguiente">
                <span id="btnSiguienteTexto">‚û°Ô∏è</span> Siguiente asignatura
            </button>
        </div>
    </div>
</div>

<script>
// Variables globales
let asignaturas = [];
let respuestas = {};
let indice = 0;
let ratingAsignatura = 0;
let ratingDocente = 0;
let correoUsuario = "";
let usandoOtroDocente = false;

// Descriptores para las opciones
const descripciones = {
    teorica: "La asignatura se enfoca en el estudio de conceptos, teor√≠as y marcos conceptuales. Se eval√∫a mediante ensayos, ex√°menes te√≥ricos y an√°lisis cr√≠tico.",
    investigacion: "La asignatura promueve la investigaci√≥n acad√©mica, con √©nfasis en metodolog√≠as de investigaci√≥n, recolecci√≥n de datos y producci√≥n de conocimiento nuevo.",
    tecnica: "Enfocada en el desarrollo de habilidades pr√°cticas, dominio de herramientas y t√©cnicas espec√≠ficas del campo art√≠stico.",
    practicas: "La evaluaci√≥n se basa principalmente en ejercicios pr√°cticos, ensayos t√©cnicos y entregas f√≠sicas de trabajo.",
    proyectos: "Se eval√∫a mediante proyectos integrales que pueden incluir investigaci√≥n, desarrollo y presentaci√≥n final.",
    lecturas: "La calificaci√≥n depende de an√°lisis de lecturas, exposiciones orales y discusiones en clase.",
    participacion: "Se valora la participaci√≥n activa en clase, reflexiones personales y contribuciones al debate acad√©mico."
};

// DOM Elements
const select = document.getElementById("selectAsignaturas");
const lista = document.getElementById("listaAsignaturas");
const contador = document.getElementById("contador");
const bloqueGeneral = document.getElementById("bloqueGeneral");

// Inicializaci√≥n con recuperaci√≥n de datos
document.addEventListener('DOMContentLoaded', function() {
    inicializarEstrellas();
    document.getElementById('btnAnterior').style.display = 'none';
    
    // Intentar recuperar datos guardados
    recuperarDatosGuardados();
    
    // Guardar autom√°ticamente cada 10 segundos
    setInterval(guardarEnLocalStorage, 10000);
    
    // Guardar tambi√©n cuando el usuario cierre la p√°gina
    window.addEventListener('beforeunload', function() {
        guardarEnLocalStorage();
    });
    
    // Configurar eventos para checkboxes y radios (para que funcionen en todo el label)
    configurarEventosInputs();
});

/* ========== CONFIGURAR EVENTOS PARA INPUTS ========== */
function configurarEventosInputs() {
    // Checkboxes - hacer que todo el label sea clickeable
    document.querySelectorAll('.checkbox-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        item.addEventListener('click', function(e) {
            if (e.target !== checkbox) {
                checkbox.checked = !checkbox.checked;
                const event = new Event('change');
                checkbox.dispatchEvent(event);
                actualizarEstiloCheckbox(item, checkbox.checked);
            }
        });
        
        // Inicializar estilo
        actualizarEstiloCheckbox(item, checkbox.checked);
    });
    
    // Radios - hacer que todo el label sea clickeable
    document.querySelectorAll('.radio-item').forEach(item => {
        const radio = item.querySelector('input[type="radio"]');
        item.addEventListener('click', function(e) {
            if (e.target !== radio) {
                radio.checked = true;
                const event = new Event('change');
                radio.dispatchEvent(event);
                actualizarEstiloRadio(item);
            }
        });
        
        // Inicializar estilo
        actualizarEstiloRadio(item);
    });
}

function actualizarEstiloCheckbox(item, checked) {
    if (checked) {
        item.classList.add('checked');
    } else {
        item.classList.remove('checked');
    }
}

function actualizarEstiloRadio(item) {
    const radio = item.querySelector('input[type="radio"]');
    const radioGroup = radio.name;
    
    // Primero quitar 'checked' de todos los radios del mismo grupo
    document.querySelectorAll(`.radio-item input[name="${radioGroup}"]`).forEach(r => {
        r.closest('.radio-item').classList.remove('checked');
    });
    
    // Luego agregar 'checked' solo al seleccionado
    if (radio.checked) {
        item.classList.add('checked');
    }
}

/* ========== FILTRAR ASIGNATURAS ========== */
function filtrarAsignaturas() {
    const busqueda = document.getElementById('buscarAsignatura').value.toLowerCase();
    const opciones = document.querySelectorAll('#selectAsignaturas option');
    let encontradas = false;
    
    opciones.forEach(opcion => {
        if (opcion.value === "") {
            opcion.style.display = 'block';
            return;
        }
        
        const texto = opcion.textContent.toLowerCase();
        if (texto.includes(busqueda)) {
            opcion.style.display = 'block';
            encontradas = true;
        } else {
            opcion.style.display = 'none';
        }
    });
    
    // Si hay b√∫squeda y no se encontr√≥ nada, mostrar mensaje
    if (busqueda && !encontradas) {
        if (!document.getElementById('noResultados')) {
            const noResultados = document.createElement('option');
            noResultados.id = 'noResultados';
            noResultados.value = '';
            noResultados.textContent = 'No se encontraron asignaturas con ese nombre';
            noResultados.disabled = true;
            select.appendChild(noResultados);
        }
    } else {
        const noResultados = document.getElementById('noResultados');
        if (noResultados) {
            noResultados.remove();
        }
    }
}

/* ========== AGREGAR ASIGNATURA ========== */
function agregarAsignatura() {
    const val = select.value;
    if (!val || val === "" || val.includes("No se encontraron")) {
        return;
    }
    
    if (asignaturas.includes(val)) {
        alert("Esta asignatura ya fue seleccionada.");
        select.value = "";
        return;
    }
    
    if (asignaturas.length >= 5) {
        alert("¬°Ya seleccionaste el m√°ximo de 5 asignaturas! Elimina alguna para agregar otra.");
        select.value = "";
        return;
    }
    
    asignaturas.push(val);
    renderSeleccion();
    select.value = "";
    
    // Limpiar b√∫squeda
    document.getElementById('buscarAsignatura').value = '';
    // Restaurar todas las opciones
    document.querySelectorAll('#selectAsignaturas option').forEach(opcion => {
        opcion.style.display = 'block';
    });
    
    // Habilitar bot√≥n de continuar si hay al menos una asignatura
    document.getElementById("btnContinuarAsignaturas").disabled = asignaturas.length === 0;
    
    // Guardar en localStorage
    guardarEnLocalStorage();
}

/* ========== VALIDACI√ìN DE CORREO ========== */
function validarCorreo(correo) {
    const correoInput = document.getElementById("correoInstitucional");
    const btnContinuar = document.getElementById("btnContinuarCorreo");
    const errorMsg = document.getElementById("errorCorreo");
    const iconValid = correoInput.parentNode.querySelector('.validation-icon.valid');
    const iconInvalid = correoInput.parentNode.querySelector('.validation-icon.invalid');
    
    // Reset
    errorMsg.style.display = 'none';
    iconValid.style.display = 'none';
    iconInvalid.style.display = 'none';
    correoInput.style.borderColor = '';
    
    if (!correo) {
        btnContinuar.disabled = true;
        return false;
    }
    
    const esValido = correo.toLowerCase().endsWith('@unal.edu.co');
    
    if (esValido) {
        iconValid.style.display = 'block';
        correoInput.style.borderColor = 'var(--success-color)';
        btnContinuar.disabled = false;
        return true;
    } else {
        iconInvalid.style.display = 'block';
        correoInput.style.borderColor = 'var(--danger-color)';
        btnContinuar.disabled = true;
        
        if (correo.includes('@') && !correo.endsWith('@unal.edu.co')) {
            errorMsg.textContent = 'El correo debe terminar en @unal.edu.co';
            errorMsg.style.display = 'block';
        }
        return false;
    }
}

function verificarCorreo() {
    const correo = document.getElementById("correoInstitucional").value.trim();
    
    if (validarCorreo(correo)) {
        correoUsuario = correo;
        document.getElementById("correoMostrado").textContent = correo;
        document.getElementById("pasoEmail").classList.add("oculto");
        document.getElementById("pasoSeleccion").classList.remove("oculto");
        window.scrollTo({ top: 0, behavior: "smooth" });
        
        // Guardar correo en localStorage
        guardarEnLocalStorage();
    }
}

/* ========== FUNCIONALIDAD DE SELECCI√ìN ========== */
function renderSeleccion() {
    lista.innerHTML = "";
    asignaturas.forEach((a, i) => {
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.innerHTML = `${a} <span class="close">√ó</span>`;
        
        // Hacer que toda la etiqueta sea clickeable para eliminar
        tag.onclick = (e) => {
            // Si click en la X o en cualquier parte
            asignaturas.splice(i, 1);
            delete respuestas[i];
            renderSeleccion();
            document.getElementById("btnContinuarAsignaturas").disabled = asignaturas.length === 0;
            guardarEnLocalStorage();
        };
        lista.appendChild(tag);
    });
    contador.textContent = `${asignaturas.length} / 5 seleccionadas`;
}

/* ========== MANEJO DE DOCENTE "OTRO" ========== */
function manejarCambioDocente() {
    const selectDocente = document.getElementById("docente");
    const inputOtroDiv = document.getElementById("inputOtroDocente");
    const errorDocente = document.getElementById("errorDocente");
    
    if (selectDocente.value === "otro") {
        inputOtroDiv.classList.remove("oculto");
        usandoOtroDocente = true;
        errorDocente.style.display = 'none';
    } else {
        inputOtroDiv.classList.add("oculto");
        usandoOtroDocente = false;
        errorDocente.style.display = 'none';
    }
    
    guardarEnLocalStorage();
}

/* ========== DESCRIPCIONES DE OPCIONES ========== */
function mostrarDescripcion(tipo) {
    const descripcionDiv = tipo in {teorica:1, investigacion:1, tecnica:1} 
        ? document.getElementById('descripcionEnfoque')
        : document.getElementById('descripcionCalificacion');
    
    if (descripciones[tipo]) {
        descripcionDiv.innerHTML = `<strong>¬øQu√© significa?</strong><br>${descripciones[tipo]}`;
        descripcionDiv.classList.remove('oculto');
    }
}

// Cerrar descripci√≥n cuando se deselecciona
document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', function() {
        actualizarEstiloCheckbox(this.closest('.checkbox-item'), this.checked);
        
        if (!this.checked) {
            const descripcionDiv = this.name === 'enfoque' 
                ? document.getElementById('descripcionEnfoque')
                : document.getElementById('descripcionCalificacion');
            
            const otrosCheckboxes = document.querySelectorAll(`input[name="${this.name}"]:checked`);
            if (otrosCheckboxes.length === 0) {
                descripcionDiv.classList.add('oculto');
            }
        }
        guardarEnLocalStorage();
    });
});

// Eventos para radios
document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        actualizarEstiloRadio(this.closest('.radio-item'));
        guardarEnLocalStorage();
    });
});

/* ========== SISTEMA DE ESTRELLAS ========== */
function inicializarEstrellas() {
    // Event listeners para hover
    document.querySelectorAll('#estrellasAsignatura span').forEach((star, index) => {
        star.addEventListener('mouseover', () => {
            resetearEstrellas('asignatura');
            highlightEstrellas(index + 1, 'asignatura');
        });
    });

    document.querySelectorAll('#estrellasDocente span').forEach((star, index) => {
        star.addEventListener('mouseover', () => {
            resetearEstrellas('docente');
            highlightEstrellas(index + 1, 'docente');
        });
    });

    // Reset al salir del contenedor
    document.getElementById('estrellasAsignatura').addEventListener('mouseleave', () => {
        resetearEstrellas('asignatura');
        highlightEstrellas(ratingAsignatura, 'asignatura');
    });

    document.getElementById('estrellasDocente').addEventListener('mouseleave', () => {
        resetearEstrellas('docente');
        highlightEstrellas(ratingDocente, 'docente');
    });
}

function calificar(puntuacion, tipo) {
    if (tipo === 'asignatura') {
        ratingAsignatura = puntuacion;
        document.getElementById('errorRatingAsignatura').style.display = 'none';
        
        // Actualizar radio button correspondiente
        const radio = document.querySelector(`input[name="ratingAsignatura"][value="${puntuacion}"]`);
        if (radio) radio.checked = true;
    } else {
        ratingDocente = puntuacion;
        document.getElementById('errorRatingDocente').style.display = 'none';
        
        // Actualizar radio button correspondiente
        const radio = document.querySelector(`input[name="ratingDocente"][value="${puntuacion}"]`);
        if (radio) radio.checked = true;
    }
    highlightEstrellas(puntuacion, tipo);
    guardarEnLocalStorage();
}

function highlightEstrellas(puntuacion, tipo) {
    const estrellas = tipo === 'asignatura' 
        ? document.querySelectorAll('#estrellasAsignatura span')
        : document.querySelectorAll('#estrellasDocente span');
    
    estrellas.forEach((star, index) => {
        if (index < puntuacion) {
            star.classList.add('activa');
        } else {
            star.classList.remove('activa');
        }
    });
}

function resetearEstrellas(tipo) {
    const estrellas = tipo === 'asignatura' 
        ? document.querySelectorAll('#estrellasAsignatura span')
        : document.querySelectorAll('#estrellasDocente span');
    
    estrellas.forEach(star => {
        star.classList.remove('activa');
    });
}

/* ========== VALIDACI√ìN ========== */
function validarFormulario() {
    let valido = true;
    
    // Reset errores
    document.querySelectorAll('.error-message').forEach(e => e.style.display = 'none');
    
    // Validar solo si no es Taller
    if (!bloqueGeneral.classList.contains('oculto')) {
        // Validar enfoque
        const enfoques = document.querySelectorAll("input[name='enfoque']:checked");
        if (enfoques.length === 0) {
            document.getElementById('errorEnfoque').style.display = 'block';
            valido = false;
        }
        
        // Validar calificaci√≥n
        const calificaciones = document.querySelectorAll("input[name='calificacion']:checked");
        if (calificaciones.length === 0) {
            document.getElementById('errorCalificacion').style.display = 'block';
            valido = false;
        }
        
        // Validar carga
        const carga = document.querySelector("input[name='carga']:checked");
        if (!carga) {
            document.getElementById('errorCarga').style.display = 'block';
            valido = false;
        }
        
        // Validar gasto
        const gasto = document.querySelector("input[name='gasto']:checked");
        if (!gasto) {
            document.getElementById('errorGasto').style.display = 'block';
            valido = false;
        }
        
        // Validar rating asignatura
        if (ratingAsignatura === 0) {
            document.getElementById('errorRatingAsignatura').style.display = 'block';
            valido = false;
        }
    }
    
    // Validar docente (siempre)
    const selectDocente = document.getElementById("docente");
    let docenteValido = false;
    
    if (usandoOtroDocente) {
        const otroDocente = document.getElementById("nombreOtroDocente").value.trim();
        if (otroDocente) {
            docenteValido = true;
        } else {
            document.getElementById("errorOtroDocente").style.display = 'block';
            valido = false;
        }
    } else if (selectDocente.value && selectDocente.value !== "otro") {
        docenteValido = true;
    } else {
        document.getElementById("errorDocente").style.display = 'block';
        valido = false;
    }
    
    // Validar rating docente (siempre obligatorio)
    if (ratingDocente === 0) {
        document.getElementById('errorRatingDocente').style.display = 'block';
        valido = false;
    }
    
    return valido;
}

/* ========== INICIAR FORMULARIO ========== */
function iniciar() {
    if (asignaturas.length === 0) {
        alert("Por favor selecciona al menos una asignatura para continuar.");
        return;
    }
    document.getElementById("pasoSeleccion").classList.add("oculto");
    document.getElementById("pasoFormulario").classList.remove("oculto");
    
    // Mostrar/ocultar bot√≥n anterior
    document.getElementById('btnAnterior').style.display = asignaturas.length > 1 ? 'flex' : 'none';
    document.getElementById('btnSiguienteTexto').textContent = asignaturas.length > 1 ? 'Siguiente asignatura' : 'Finalizar';
    
    mostrar();
    guardarEnLocalStorage();
}

/* ========== MOSTRAR ASIGNATURA ACTUAL ========== */
function mostrar() {
    const actual = asignaturas[indice];
    
    document.getElementById("tituloAsignatura").textContent = actual;
    document.getElementById("progreso").textContent = `Asignatura ${indice + 1} de ${asignaturas.length}`;
    
    // Actualizar texto del bot√≥n
    const esUltima = indice === asignaturas.length - 1;
    document.getElementById('btnSiguienteTexto').textContent = esUltima ? 'Finalizar' : 'Siguiente asignatura';
    document.getElementById('btnAnterior').style.display = indice > 0 ? 'flex' : 'none';
    
    // L√≥gica Taller
    if (actual.includes("Taller")) {
        bloqueGeneral.classList.add("oculto");
    } else {
        bloqueGeneral.classList.remove("oculto");
    }
    
    cargar();
    window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ========== GUARDAR Y CARGAR DATOS ========== */
function guardar() {
    let docenteNombre = "";
    
    if (usandoOtroDocente) {
        docenteNombre = document.getElementById("nombreOtroDocente").value.trim();
    } else {
        docenteNombre = document.getElementById("docente").value;
    }
    
    respuestas[indice] = {
        asignatura: asignaturas[indice],
        enfoque: [...document.querySelectorAll("input[name='enfoque']:checked")].map(e => e.value),
        calificacion: [...document.querySelectorAll("input[name='calificacion']:checked")].map(e => e.value),
        carga: document.querySelector("input[name='carga']:checked")?.value || "",
        gasto: document.querySelector("input[name='gasto']:checked")?.value || "",
        ratingAsignatura: ratingAsignatura,
        opinionAsignatura: document.getElementById("opinionAsignatura").value,
        docente: docenteNombre,
        ratingDocente: ratingDocente,
        opinionDocente: document.getElementById("opinionDocente").value
    };
    
    guardarEnLocalStorage();
}

function cargar() {
    limpiarFormulario();
    if (!respuestas[indice]) {
        ratingAsignatura = 0;
        ratingDocente = 0;
        usandoOtroDocente = false;
        return;
    }
    
    const data = respuestas[indice];
    
    // Restaurar checkboxes
    data.enfoque?.forEach(v => {
        const el = document.querySelector(`input[name="enfoque"][value="${v}"]`);
        if (el) {
            el.checked = true;
            actualizarEstiloCheckbox(el.closest('.checkbox-item'), true);
        }
    });
    
    data.calificacion?.forEach(v => {
        const el = document.querySelector(`input[name="calificacion"][value="${v}"]`);
        if (el) {
            el.checked = true;
            actualizarEstiloCheckbox(el.closest('.checkbox-item'), true);
        }
    });
    
    // Restaurar radios
    if (data.carga) {
        const el = document.querySelector(`input[name="carga"][value="${data.carga}"]`);
        if (el) {
            el.checked = true;
            actualizarEstiloRadio(el.closest('.radio-item'));
        }
    }
    
    if (data.gasto) {
        const el = document.querySelector(`input[name="gasto"][value="${data.gasto}"]`);
        if (el) {
            el.checked = true;
            actualizarEstiloRadio(el.closest('.radio-item'));
        }
    }
    
    // Restaurar estrellas
    ratingAsignatura = data.ratingAsignatura || 0;
    ratingDocente = data.ratingDocente || 0;
    highlightEstrellas(ratingAsignatura, 'asignatura');
    highlightEstrellas(ratingDocente, 'docente');
    
    // Restaurar radio buttons de estrellas
    if (ratingAsignatura > 0) {
        const radio = document.querySelector(`input[name="ratingAsignatura"][value="${ratingAsignatura}"]`);
        if (radio) radio.checked = true;
    }
    
    if (ratingDocente > 0) {
        const radio = document.querySelector(`input[name="ratingDocente"][value="${ratingDocente}"]`);
        if (radio) radio.checked = true;
    }
    
    // Restaurar docente
    if (data.docente) {
        // Verificar si el docente est√° en la lista
        const selectDocente = document.getElementById("docente");
        let encontrado = false;
        
        for (let i = 0; i < selectDocente.options.length; i++) {
            if (selectDocente.options[i].value === data.docente) {
                selectDocente.value = data.docente;
                encontrado = true;
                usandoOtroDocente = false;
                break;
            }
        }
        
        if (!encontrado && data.docente) {
            selectDocente.value = "otro";
            usandoOtroDocente = true;
            document.getElementById("inputOtroDocente").classList.remove("oculto");
            document.getElementById("nombreOtroDocente").value = data.docente;
        }
    }
    
    // Restaurar textos
    document.getElementById("opinionAsignatura").value = data.opinionAsignatura || "";
    document.getElementById("opinionDocente").value = data.opinionDocente || "";
    
    // Restaurar descripciones si hay checkboxes seleccionados
    if (data.enfoque && data.enfoque.length > 0) {
        const primerEnfoque = data.enfoque[0].toLowerCase();
        if (primerEnfoque.includes('te√≥rica')) mostrarDescripcion('teorica');
        else if (primerEnfoque.includes('investigaci√≥n')) mostrarDescripcion('investigacion');
        else if (primerEnfoque.includes('t√©cnica')) mostrarDescripcion('tecnica');
    }
}

function limpiarFormulario() {
    // Limpiar checkboxes
    document.querySelectorAll('.checkbox-item').forEach(item => {
        item.classList.remove('checked');
    });
    document.querySelectorAll('input[type="checkbox"]').forEach(i => i.checked = false);
    
    // Limpiar radios
    document.querySelectorAll('.radio-item').forEach(item => {
        item.classList.remove('checked');
    });
    document.querySelectorAll('input[type="radio"]').forEach(i => i.checked = false);
    
    // Limpiar estrellas
    ratingAsignatura = 0;
    ratingDocente = 0;
    resetearEstrellas('asignatura');
    resetearEstrellas('docente');
    
    // Limpiar textos
    document.querySelectorAll("textarea").forEach(t => t.value = "");
    
    // Resetear docente
    document.getElementById("docente").value = "";
    document.getElementById("inputOtroDocente").classList.add("oculto");
    document.getElementById("nombreOtroDocente").value = "";
    usandoOtroDocente = false;
    
    // Limpiar descripciones
    document.getElementById("descripcionEnfoque").classList.add('oculto');
    document.getElementById("descripcionCalificacion").classList.add('oculto');
    
    // Reset errores
    document.querySelectorAll('.error-message').forEach(e => e.style.display = 'none');
}

/* ========== GUARDADO EN LOCALSTORAGE ========== */
function guardarEnLocalStorage() {
    try {
        const datosGuardar = {
            correoUsuario: correoUsuario,
            asignaturas: asignaturas,
            respuestas: respuestas,
            indice: indice,
            ratingAsignatura: ratingAsignatura,
            ratingDocente: ratingDocente,
            usandoOtroDocente: usandoOtroDocente,
            timestamp: new Date().getTime()
        };
        
        localStorage.setItem('opinionesArtesUNAL', JSON.stringify(datosGuardar));
        console.log('Datos guardados en localStorage');
    } catch (error) {
        console.error('Error guardando en localStorage:', error);
    }
}

function recuperarDatosGuardados() {
    try {
        const datosGuardados = localStorage.getItem('opinionesArtesUNAL');
        if (!datosGuardados) return;
        
        const datos = JSON.parse(datosGuardados);
        
        // Verificar si los datos son muy viejos (m√°s de 24 horas)
        const ahora = new Date().getTime();
        if (ahora - datos.timestamp > 24 * 60 * 60 * 1000) {
            localStorage.removeItem('opinionesArtesUNAL');
            return;
        }
        
        // Preguntar al usuario si quiere recuperar
        if (confirm('Encontramos un formulario en progreso. ¬øDeseas continuar donde lo dejaste?')) {
            // Restaurar datos
            correoUsuario = datos.correoUsuario || '';
            asignaturas = datos.asignaturas || [];
            respuestas = datos.respuestas || {};
            indice = datos.indice || 0;
            ratingAsignatura = datos.ratingAsignatura || 0;
            ratingDocente = datos.ratingDocente || 0;
            usandoOtroDocente = datos.usandoOtroDocente || false;
            
            // Si ya tenemos correo, ir directamente a selecci√≥n
            if (correoUsuario) {
                document.getElementById("correoMostrado").textContent = correoUsuario;
                document.getElementById("correoInstitucional").value = correoUsuario;
                document.getElementById("pasoEmail").classList.add("oculto");
                
                // Si ya tenemos asignaturas, ir al formulario
                if (asignaturas.length > 0) {
                    document.getElementById("pasoSeleccion").classList.add("oculto");
                    document.getElementById("pasoFormulario").classList.remove("oculto");
                    mostrar();
                } else {
                    document.getElementById("pasoSeleccion").classList.remove("oculto");
                    renderSeleccion();
                    document.getElementById("btnContinuarAsignaturas").disabled = asignaturas.length === 0;
                }
            }
        } else {
            // Si el usuario no quiere recuperar, limpiar localStorage
            localStorage.removeItem('opinionesArtesUNAL');
        }
    } catch (error) {
        console.error('Error recuperando datos:', error);
        localStorage.removeItem('opinionesArtesUNAL');
    }
}

/* ========== NAVEGACI√ìN ========== */
function siguiente() {
    if (!validarFormulario()) {
        alert("Por favor completa todos los campos obligatorios antes de continuar.");
        return;
    }
    
    guardar();
    
    if (indice < asignaturas.length - 1) {
        indice++;
        mostrar();
    } else {
        if (confirm("¬øEst√°s seguro de que deseas enviar todas tus respuestas?")) {
            enviarRespuestas();
        }
    }
}

function anterior() {
    guardar();
    if (indice > 0) {
        indice--;
        mostrar();
    }
}

/* ========== GENERAR RESUMEN ========== */
function generarResumen() {
    let resumenHTML = "";
    
    Object.values(respuestas).forEach((resp, i) => {
        resumenHTML += `
            <div class="respuesta-item">
                <h4>${i+1}. ${resp.asignatura}</h4>
                <div class="respuesta-detalle">
                    <p><strong>Enfoque:</strong> ${resp.enfoque?.join(', ') || 'No aplica'}</p>
                    <p><strong>Calificaci√≥n:</strong> ${resp.calificacion?.join(', ') || 'No aplica'}</p>
                    <p><strong>Carga:</strong> ${resp.carga || 'No especificado'}</p>
                    <p><strong>Gasto:</strong> ${resp.gasto || 'No especificado'}</p>
                    <p><strong>Valoraci√≥n materia:</strong> ${resp.ratingAsignatura || 0}/5 ‚≠ê</p>
                    <p><strong>Docente:</strong> ${resp.docente || 'No especificado'}</p>
                    <p><strong>Valoraci√≥n docente:</strong> ${resp.ratingDocente || 0}/5 ‚≠ê</p>
                </div>
            </div>
        `;
    });
    
    return resumenHTML;
}

/* ========== ENVIAR RESPUESTAS A GOOGLE SHEETS ========== */
function enviarRespuestas() {
    // Bloqueamos el bot√≥n para evitar que le den click muchas veces
    const btnSiguiente = document.getElementById('btnSiguiente');
    if(btnSiguiente) btnSiguiente.disabled = true;

    const datosParaEnviar = {
        correo: correoUsuario,
        fecha: new Date().toLocaleString('es-CO'),
        respuestas: respuestas
    };

    // URL DEL SHEETS
    const URL_GOOGLE_SCRIPT = "https://script.google.com/macros/s/AKfycbzgT0EWFYPD9BbJSzlx_TI5eC3bEyeliYJrE7eA4lQM42BDEGvGQBY2Yr69Le_UWOcEtQ/exec"; 

    fetch(URL_GOOGLE_SCRIPT, {
        method: 'POST',
        mode: 'no-cors', 
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(datosParaEnviar)
    })
    .then(() => {
        // √âxito: Mostramos el resumen y la pantalla final
        document.getElementById('resumenRespuestas').innerHTML = generarResumen();
        document.getElementById("pasoFormulario").classList.add("oculto");
        document.getElementById("pantallaFinal").classList.remove("oculto");
        window.scrollTo({ top: 0, behavior: "smooth" });
        
        // Limpiar localStorage despu√©s de enviar
        localStorage.removeItem('opinionesArtesUNAL');
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Hubo un problema al enviar tus respuestas. Por favor, int√©ntalo de nuevo.');
        if(btnSiguiente) btnSiguiente.disabled = false;
    });
}

/* ========== REINICIAR FORMULARIO ========== */
function reiniciar() {
    // Limpiar localStorage
    localStorage.removeItem('opinionesArtesUNAL');
    
    // Reiniciar todas las variables
    asignaturas = [];
    respuestas = {};
    indice = 0;
    ratingAsignatura = 0;
    ratingDocente = 0;
    correoUsuario = "";
    usandoOtroDocente = false;
    
    // Limpiar interfaz
    lista.innerHTML = "";
    contador.textContent = "0 / 5 seleccionadas";
    document.getElementById("btnContinuarAsignaturas").disabled = true;
    document.getElementById('correoInstitucional').value = '';
    document.getElementById('correoInstitucional').style.borderColor = '';
    document.getElementById('buscarAsignatura').value = '';
    document.querySelectorAll('.validation-icon').forEach(icon => icon.style.display = 'none');
    document.getElementById('errorCorreo').style.display = 'none';
    document.getElementById('btnContinuarCorreo').disabled = true;
    
    // Restaurar todas las opciones en el select
    document.querySelectorAll('#selectAsignaturas option').forEach(opcion => {
        opcion.style.display = 'block';
    });
    
    // Mostrar paso inicial
    document.getElementById("pantallaFinal").classList.add("oculto");
    document.getElementById("pasoFormulario").classList.add("oculto");
    document.getElementById("pasoSeleccion").classList.add("oculto");
    document.getElementById("pasoEmail").classList.remove("oculto");
    
    // Limpiar formulario
    limpiarFormulario();
}
</script>

</body>
</html>
